<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>San Lorenzo Animal Bite Center - Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='employee-styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='audit-log.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='select-styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='print-styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='report-generator.js') }}"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='images/san lorenzo.jpg') }}" alt="Clinic Logo" class="sidebar-logo">
        <h3 style="color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">San Lorenzo Animal Bite Center</h3>
      </div>
      <ul class="sidebar-menu">
        <li><button class="menu-btn active" onclick="showSection('dashboard')">Dashboard</button></li>
        <li><button class="menu-btn" onclick="showSection('add-record')">Add Record</button></li>
        <li><button class="menu-btn" onclick="showSection('view-patient')">View Patient</button></li>
        <li><button class="menu-btn" onclick="showSection('view-schedule')">View Schedule</button></li>
        <li><button class="menu-btn" onclick="showSection('view-employees')">View Employees</button></li>
        <li><button class="menu-btn" onclick="showSection('add-employee')">Add Employee Account</button></li>
      </ul>
      <div class="sidebar-bottom">
        <div class="employee-greeting">
          <div class="greeting-text">Hi, {{ employee_name }}!</div>
        </div>
        <div class="sidebar-bottom-actions">
          <a href="{{ url_for('logout') }}" class="menu-btn sidebar-bottom-btn">Logout</a>
          <button class="menu-btn sidebar-bottom-btn" onclick="showSection('settings')">Settings</button>
        </div>
      </div>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard -->
      <section id="dashboard" class="content-section active">
        <h2>Dashboard (Admin)</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üë§</div>
            <h3>Total Patients</h3>
            <div class="stat-number">{{ patients|length }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <h3>Upcoming Appointments</h3>
            <div class="stat-number">{{ upcoming_appointments[0]['count'] if upcoming_appointments else 0 }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <h3>Patients Today</h3>
            <div class="stat-number">{{ patients_today[0]['count'] if patients_today else 0 }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <h3>Completed Treatments</h3>
            <div class="stat-number" id="completed-count">0</div>
          </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="analytics-section">
          <div class="analytics-header">
            <h3>Treatment Analytics</h3>
            <div class="analytics-controls">
              <label for="periodType">Period:</label>
              <select id="periodType" onchange="updateMonthlyReports()">
                <option value="month" selected>Monthly</option>
                <option value="year">Yearly</option>
              <!DOCTYPE html>
              <html lang="en">
              <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>San Lorenzo Animal Bite Center - Admin Dashboard</title>
                <link rel="stylesheet" href="{{ url_for('static', filename='employee-styles.css') }}">
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              </head>
              <body>
                <div class="dashboard-container">
                  <!-- Sidebar -->
                  <nav class="sidebar">
                    <div class="sidebar-header">
                      <img src="{{ url_for('static', filename='images/san lorenzo.jpg') }}" alt="Clinic Logo" class="sidebar-logo">
                       <h3 class="clinic-title" style="color:#fff !important;">San Lorenzo Animal Bite Center</h3>
                    </div>
                    <ul class="sidebar-menu">
                      <li><button class="menu-btn active" onclick="showSection('dashboard')">Dashboard</button></li>
                      <li><button class="menu-btn" onclick="showSection('add-record')">Add Record</button></li>
                      <li><button class="menu-btn" onclick="showSection('view-patient')">View Patient</button></li>
                      <li><button class="menu-btn" onclick="showSection('view-schedule')">View Schedule</button></li>
                    </ul>
                    <div class="sidebar-bottom">
                      <div class="employee-greeting">
                        <div class="greeting-text">Hi, {{ employee_name }}!</div>
                      </div>
                      <div class="sidebar-bottom-actions">
                        <a href="{{ url_for('logout') }}" class="menu-btn sidebar-bottom-btn">Logout</a>
                        <button class="menu-btn sidebar-bottom-btn" onclick="showSection('settings')">Settings</button>
                      </div>
                    </div>
                    </ul>
                  </nav>

                  <!-- Main Content -->
                  <main class="main-content">
                    <!-- Dashboard -->
                    <section id="dashboard" class="content-section active">
                      <h2>Dashboard</h2>
                      <div class="stats-grid">
                        <div class="stat-card">
                          <div class="stat-icon">üë§</div>
                          <h3>Total Patients</h3>
                          <div class="stat-number">{{ patients|length }}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-icon">üìÖ</div>
                          <h3>Upcoming Appointments</h3>
                          <div class="stat-number">{{ upcoming_appointments[0]['count'] if upcoming_appointments else 0 }}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-icon">üìÖ</div>
                          <h3>Patients Today</h3>
                          <div class="stat-number">{{ patients_today[0]['count'] if patients_today else 0 }}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-icon">‚úÖ</div>
                          <h3>Completed Treatments</h3>
                          <div class="stat-number" id="completed-count">0</div>
                        </div>
                      </div>

                      <!-- Analytics Charts Section -->
                      <div class="analytics-section">
                        <div class="analytics-header">
                          <h3 style="color: #ffffff;">Treatment Analytics</h3>
                          <div class="analytics-controls">
                            <label for="periodType">Period:</label>
                            <select id="periodType" onchange="updateMonthlyReports()">
                              <option value="month" selected>Monthly</option>
                              <option value="year">Yearly</option>
                            </select>
                            <label for="monthSelector">View:</label>
                            <select id="monthSelector" onchange="updateMonthlyReports()">
                              <option value="weekly">This Week</option>
                              <option value="monthly" selected>This Month</option>
                              <option value="yearly">This Year</option>
                            </select>
                            <button id="generateReport" onclick="testGenerateReport()" class="btn-report">üìä Generate Report</button>
                          </div>
                        </div>
          
                        <!-- Monthly Summary Cards -->
                        <div class="monthly-summary" id="monthlySummary">
                          <div class="summary-card">
                            <h4 style="color:#fff !important;">New Patients</h4>
                            <div class="summary-number" id="monthlyNewPatients">0</div>
                          </div>
                          
                          <div class="summary-card">
                            <h4 style="color:#fff !important;">Active Treatments</h4>
                            <div class="summary-number" id="monthlyActive">0</div>
                          </div>
                          <div class="summary-card">
                            <h4 style="color:#fff !important;">Completion Rate</h4>
                            <div class="summary-number" id="monthlyRate">0%</div>
                          </div>
                        </div>
                        

                        <div class="charts-grid">
                          <div class="chart-container">
                            <h4>Treatment Completion Status</h4>
                            <canvas id="completionChart" width="400" height="200"></canvas>
                          </div>
                          <div class="chart-container">
                            <h4>Daily Progress (Selected Month)</h4>
                            <canvas id="dailyProgressChart" width="400" height="200"></canvas>
                          </div>
                          <div class="chart-container">
                            <h4>Treatment Types Distribution</h4>
                            <canvas id="serviceChart" width="400" height="200"></canvas>
                          </div>
                          <div class="chart-container">
                            <h4>Weekly Completion Trends</h4>
                            <canvas id="weeklyTrendChart" width="400" height="200"></canvas>
                          </div>
                        </div>
          
                        <!-- Monthly Report Section -->
                        <div class="monthly-report" id="monthlyReportSection" style="display:none;">
                          <h4>üìà Report</h4>
                          <div class="report-content" id="reportContent"></div>
                          <button onclick="printProfessionalReport()" class="btn-print">üñ®Ô∏è Print Report</button>
                        </div>
                      </div>
                    </section>

                    <!-- Add Record -->
                    <section id="add-record" class="content-section">
                      <form method="POST" action="{{ url_for('employee_dashboard') }}">
                        <!-- Form Tabs -->
                        <div class="form-header">
                          <div class="form-tabs">
                            <button
                              type="button"
                              class="tab-btn active"
                              onclick="showTab('personal-info')"
                            >
                              Personal Information
                            </button>
                            <button
                              type="button"
                              class="tab-btn"
                              onclick="showTab('vaccine-bite-info')"
                            >
                              Vaccine and Bite Information
                            </button>
                            <button
                              type="button"
                              class="tab-btn"
                              onclick="showTab('schedule')"
                            >
                              Schedule
                            </button>
                            </div>
                          </div>

                        <!-- Personal Info -->
                        <div id="personal-info" class="tab-content active">
                          <div class="form-grid">
                            <div class="form-section-header">
                              <h4>Personal Information</h4>
                            </div>
              
                            <div class="form-group">
                              <label>Patient Name:</label>
                              <input type="text" name="patient_name" placeholder="Enter patient's full name" required>
                            </div>
                            <div class="form-group">
                              <label>Age:</label>
                              <input type="number" name="age" min="0" max="150" placeholder="Enter age" required>
                            </div>
                            <div class="form-group">
                              <label>Gender:</label>
                              <div class="select-wrapper">
                                <select name="gender" required placeholder="Select gender">
                                  <option value="" disabled selected hidden>Select gender</option>
                                  <option value="Male">Male</option>
                                  <option value="Female">Female</option>
                                  <option value="Other">Other</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label>Contact Number:</label>
                              <input type="tel" name="contact_number" placeholder="09XX-XXX-XXXX" required>
                            </div>
                            <div class="form-group full-width">
                              <label>Complete Address:</label>
                              <textarea name="address" rows="3" placeholder="Enter complete address including barangay, city/municipality, province" required></textarea>
                            </div>
                          </div>
                        </div>

                        <!-- Vaccine & Bite Info -->
                        <div id="vaccine-bite-info" class="tab-content">
                          <div class="form-grid">
                            <div class="form-section-header">
                              <h4>Service Information</h4>
                            </div>
              
                            <div class="form-group">
                              <label>Service Type:</label>
                              <div class="select-wrapper">
                                <select name="service_type" required placeholder="Select service type">
                                  <option value="" disabled selected hidden>Select service type</option>
                                  <option value="Booster">Booster</option>
                                  <option value="Pre-Exposure Prophylaxis">Pre-Exposure Prophylaxis</option>
                                  <option value="Post-Exposure Prophylaxis">Post-Exposure Prophylaxis</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
              
                            <div class="form-section-header">
                              <h4>Bite Incident Details</h4>
                            </div>
              
                            <div class="form-group">
                              <label>Date of Bite:</label>
                              <input type="date" name="date_of_bite" title="When did the bite incident occur?">
                            </div>
                            <div class="form-group">
                              <label>Bite Location on Body:</label>
                              <input type="text" name="bite_location" placeholder="e.g., left hand, right leg, face" title="Where on the body was the bite located?">
                            </div>
                            <div class="form-group">
                              <label>Place of Bite Incident:</label>
                              <input type="text" name="place_of_bite" placeholder="e.g., at home, in the street, at park" title="Where did the bite incident happen?">
                            </div>
                            <div class="form-group">
                              <label>Type of Bite:</label>
                              <div class="select-wrapper">
                                <select name="type_of_bite" placeholder="Select bite type">
                                  <option value="" disabled selected hidden>Select bite type</option>
                                  <option value="One Bite">Single Bite</option>
                                  <option value="Multiple Bites">Multiple Bites</option>
                                  <option value="Scratch">Scratch/Laceration</option>
                                  <option value="Lick on open wound">Lick on Open Wound</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
              
                            <div class="form-section-header">
                              <h4>Animal Information</h4>
                            </div>
              
                            <div class="form-group">
                              <label>Source of Bite:</label>
                              <div class="select-wrapper">
                                <select name="source_of_bite" placeholder="Select animal type">
                                  <option value="" disabled selected hidden>Select animal type</option>
                                  <option value="Dog">Dog</option>
                                  <option value="Cat">Cat</option>
                                  <option value="Bat">Bat</option>
                                  <option value="Monkey">Monkey</option>
                                  <option value="Other">Other Animal</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label>Other Animal Specify:</label>
                              <input type="text" name="other_source_of_bite" placeholder="Specify if 'Other' selected above">
                            </div>
                            <div class="form-group">
                              <label>Animal Status:</label>
                              <div class="select-wrapper">
                                <select name="source_status" placeholder="Select status">
                                  <option value="" disabled selected hidden>Select status</option>
                                  <option value="Alive">Alive & Observable</option>
                                  <option value="Dead">Dead/Killed</option>
                                  <option value="Unknown">Unknown/Lost</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label>Animal Ownership:</label>
                              <div class="select-wrapper">
                                <select name="exposure" required placeholder="Select ownership type">
                                  <option value="" disabled selected hidden>Select ownership type</option>
                                  <option value="Neighbor">Neighbor</option>
                                  <option value="Stranger">Stranger</option>
                                  <option value="Family">Family</option>
                                  <option value="Other">Other</option>
                                </select>
                                <div class="select-arrow">‚ñº</div>
                              </div>
                            </div>
              
                            <div class="form-section-header">
                              <h4>Vaccination History</h4>
                            </div>
                            <div class="form-group">
                              <label>Previous Rabies Vaccination Status:</label>
                              <div class="vaccination-options" style="display:flex;flex-direction:row;gap:4px;align-items:stretch;justify-content:flex-start;">
                                <div class="radio-group" style="flex:1;display:flex;align-items:center;gap:14px;min-width:320px;max-width:420px;padding:18px 20px;border:1.5px solid transparent;border-radius:12px;background:transparent;box-sizing:border-box;">
                                  <input type="radio" id="vacc-yes" name="vaccinated" value="Yes" checked required>
                                  <label for="vacc-yes" class="radio-label" style="margin-bottom:0;width:100%;">
                                    <span class="radio-button"></span>
                                    <span class="radio-text" style="display:block;">
                                      <strong>Previously Vaccinated</strong>
                                      <small style="display:block;">Patient has received anti-rabies vaccine within the last 2 years</small>
                                    </span>
                                  </label>
                                </div>
                                <div class="radio-group" style="flex:1;display:flex;align-items:center;gap:14px;min-width:320px;max-width:420px;padding:18px 20px;border:1.5px solid transparent;border-radius:12px;background:transparent;box-sizing:border-box;">
                                  <input type="radio" id="vacc-no" name="vaccinated" value="No" required>
                                  <label for="vacc-no" class="radio-label" style="margin-bottom:0;width:100%;">
                                    <span class="radio-button"></span>
                                    <span class="radio-text" style="display:block;">
                                      <strong>Not Previously Vaccinated</strong>
                                      <small style="display:block;">Patient has no prior anti-rabies vaccination or unsure</small>
                                    </span>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                          <!-- Schedule -->
                          <div id="schedule" class="tab-content schedule-section">
                            <div class="schedule-header">
                              <h3 style="color:#fff !important;">Anti-Rabies Vaccination Schedule</h3>
                            </div>
              
                            <div class="schedule-grid">
                              <div class="schedule-item priority-high">
                                <div class="schedule-day">
                                  <span class="day-number">Day 0</span>
                                  <span class="day-description">Initial dose (exposure day)</span>
                                </div>
                                <input type="date" name="day0" class="schedule-input" required />
                                <div class="schedule-status">
                                  <span class="status-badge critical">Critical</span>
                                </div>
                              </div>
                
                              <div class="schedule-item priority-high">
                                <div class="schedule-day">
                                  <span class="day-number">Day 3</span>
                                  <span class="day-description">Second dose</span>
                                </div>
                                <input type="date" name="day3" class="schedule-input" />
                                <div class="schedule-status">
                                  <span class="status-badge important">Important</span>
                                </div>
                              </div>
                
                              <div class="schedule-item priority-medium">
                                <div class="schedule-day">
                                  <span class="day-number">Day 7</span>
                                  <span class="day-description">Third dose</span>
                                </div>
                                <input type="date" name="day7" class="schedule-input" />
                                <div class="schedule-status">
                                  <span class="status-badge moderate">Moderate</span>
                                </div>
                              </div>
                
                              <div class="schedule-item priority-medium">
                                <div class="schedule-day">
                                  <span class="day-number">Day 14</span>
                                  <span class="day-description">Fourth dose</span>
                                </div>
                                <input type="date" name="day14" class="schedule-input" />
                                <div class="schedule-status">
                                  <span class="status-badge moderate">Moderate</span>
                                </div>
                              </div>
                
                              <div class="schedule-item priority-low">
                                <div class="schedule-day">
                                  <span class="day-number">Day 28</span>
                                  <span class="day-description">Final dose</span>
                                </div>
                                <input type="date" name="day28" class="schedule-input" />
                                <div class="schedule-status">
                                  <span class="status-badge low">Completion</span>
                                </div>
                              </div>
                            </div>
              
                            <div class="schedule-notes">
                              <div class="note-item">
                                <strong>Note:</strong> Dates will be auto-calculated when Day 0 is selected
                              </div>
                              <div class="note-item">
                                <strong>Important:</strong> Strict adherence to schedule is crucial for effectiveness
                              </div>
                            </div>
                          </div>

                        <!-- Actions -->
                        <div class="form-actions">
                          <button type="submit" class="btn-success">Save Record</button>
                        </div>
                      </form>
                    </section>

                    <!-- View Patient -->
                    <section id="view-patient" class="content-section">
                      <h2>Patient Records</h2>
                      <!-- Search Toolbar -->
                      <div class="table-actions" style="display:flex;align-items:center;gap:12px;margin:8px 0 12px;">
                        <input id="patient-search" type="text" placeholder="Search by ID, name, date, or service" oninput="searchPatients()" style="flex:1;max-width:420px;padding:8px 10px;border:1px solid #ccc;border-radius:6px;" />
                        <button class="btn-secondary" type="button" onclick="searchPatients()">Search</button>
                        <button class="btn-ghost" type="button" onclick="clearSearch()">Clear</button>
                        <span id="results-count" style="margin-left:auto;color:#555;font-size:.95rem;">&nbsp;</span>
                      </div>
                      <div class="table-container">
                        <table class="patient-table">
                          <thead>
                            <tr>
                              <th style="color:#fff !important;">ID</th>
                              <th style="color:#fff !important;">Patient Name</th>
                              <th style="color:#fff !important;">Date of Bite</th>
                              <th style="color:#fff !important;">Service</th>
                              <th style="color:#fff !important;">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for p in patients %}
                            <tr>
                              <td>{{ p['id'] }}</td>
                              <td>{{ p['patient_name'] }}</td>
                              <td>{{ p['date_of_bite']  }}</td>
                              <td>{{ p['service_type'] }}</td>
                              <td class="action-buttons">
                                <button class="btn-view" data-patient-id="{{ p['id'] }}" title="View Details">
                                  <img src="{{ url_for('static', filename='images/icons/istockphoto-845329690-612x612-removebg-preview.png') }}" alt="View" class="action-icon">
                                </button>
                                <button class="btn-edit" data-patient-id="{{ p['id'] }}" title="Edit Patient">
                                  <img src="{{ url_for('static', filename='images/icons/3512833-removebg-preview.png') }}" alt="Edit" class="action-icon">
                                </button>
                                <button class="btn-delete" data-patient-id="{{ p['id'] }}" title="Delete Patient">
                                  <img src="{{ url_for('static', filename='images/icons/images-removebg-preview.png') }}" alt="Delete" class="action-icon">
                                </button>
                              </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5">No patients found.</td></tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </section>

                    <!-- View Schedule -->
                    <section id="view-schedule" class="content-section">
        
                      <h2>Schedule Calendar</h2>
                      <!-- Calendar Header (ADDED) -->
                      <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
                        <div id="calendar-month-year" style="font-weight:600;"></div>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
                      </div>
                      <!-- Calendar Stats -->
                      <div class="calendar-stats">
                        <div class="stat-card">
                          <h3>Today's Patients</h3>
                          <div class="stat-number">{{ patients_today[0]['count'] if patients_today else 0 }}</div>
                        </div>
                        <!-- Calendar Grid -->
                        <div class="calendar-container">
                          <div class="calendar-weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                          </div>
                          <div class="calendar-days" id="calendar-days">
                            <!-- Calendar days will be generated by JavaScript -->
                          </div>
                        </div>

                        <!-- Schedule Legend -->
                        <div class="schedule-legend">
                          <h4>Schedule Legend:</h4>
                          <div class="legend-items">
                            <div class="legend-item">
                              <div class="legend-color day0"></div>
                              <span>Day 0 (Initial Dose)</span>
                            </div>
                            <div class="legend-item">
                              <div class="legend-color day3"></div>
                              <span>Day 3</span>
                            </div>
                            <div class="legend-item">
                              <div class="legend-color day7"></div>
                              <span>Day 7</span>
                            </div>
                            <div class="legend-item">
                              <div class="legend-color day14"></div>
                              <span>Day 14</span>
                            </div>
                            <div class="legend-item">
                              <div class="legend-color day28"></div>
                              <span>Day 28 (Final)</span>
                            </div>
                          </div>
                        </div>

                        <!-- Daily Schedule Details -->
                        <div class="daily-schedule" id="daily-schedule">
                          <h4>Appointments for <span id="selected-date"></span></h4>
                          <div class="appointment-list" id="appointment-list">
                            <p>Select a date to view appointments</p>
                          </div>
                        </div>

                        <!-- Appointment Details Modal for Calendar (used by JS) -->
                        <div id="appointmentModal" class="modal" style="display:none">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h2>Appointment Details</h2>
                              <span class="close" onclick="closeAppointmentModal()">&times;</span>
                            </div>
                            <div id="appointmentDetailsContent" class="modal-body"></div>
                          </div>
                        </div>

                        <!-- Toast Notification (for appointment actions) -->
                        <div id="copilot-toast" style="display:none"></div>

                        <!-- Appointment Actions Modal -->
                        <div id="appointmentActionsModal" class="modal">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h2>Appointment Actions</h2>
                              <span class="close" onclick="closeAppointmentModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                              <div class="appointment-info">
                                <h3 id="modal-appointment-patient"></h3>
                                <p><strong>Date:</strong> <span id="modal-appointment-date"></span></p>
                                <p><strong>Service:</strong> <span id="modal-appointment-service"></span></p>
                                <p><strong>Schedule:</strong> <span id="modal-appointment-schedule"></span></p>
                              </div>
                              <div class="appointment-actions-grid">
                                <button class="action-btn view-btn" onclick="viewAppointmentDetails()">
                                  üëÅÔ∏è View Details
                                </button>
                                <button class="action-btn done-btn" onclick="markAsDone()">
                                  ‚úÖ Mark as Done
                                </button>
                                <button class="action-btn noshow-btn" onclick="markAsNoShow()">
                                  ‚ùå Mark as No Show
                                </button>
                                <button class="action-btn reschedule-btn" onclick="rescheduleAppointment()">
                                  üìÖ Reschedule
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </section>

                      <!-- View Employees Section -->
                      <section id="view-employees" class="content-section">
                        <h2>Employee List</h2>
                        <div class="content-card">
                          <div class="section-header">
                            <div class="header-actions">
                              <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="employee-search" class="search-input" placeholder="Search employees...">
                              </div>
                              <button onclick="refreshEmployeeList()" class="btn btn-secondary">
                                <i class="fas fa-sync"></i> Refresh
                              </button>
                            </div>
                          </div>

                          <div class="table-responsive">
                            <table class="data-table employee-table">
                              <thead>
                                <tr>
                                  <th>Employee ID</th>
                                  <th>Username</th>
                                  <th>Display Name</th>
                                  <th>Role</th>
                                  <th>Last Login</th>
                                  <th>Status</th>
                                  <th>Actions</th>
                                </tr>
                              </thead>
                              <tbody id="employee-list-body">
                                <!-- Employee list will be loaded here -->
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </section>

                      <!-- Add Employee Account Section -->
                      <section id="add-employee" class="content-section">
                        <h2>Add Employee Account</h2>
                        <div class="content-card">
                          <div class="form-section">
                            <div class="section-header">
                              <h3>New Employee Information</h3>
                              <p class="section-description">Create a new employee account by filling out the form below.</p>
                            </div>
                            <form id="add-employee-form" onsubmit="return handleAddEmployee(event)" autocomplete="off">
                              <div class="form-grid two-columns">
                                <div class="form-group">
                                  <label for="new-employee-username">Username</label>
                                  <input type="text" 
                                         id="new-employee-username" 
                                         class="form-input" 
                                         required
                                         autocomplete="off"
                                         placeholder="Enter employee username"
                                         pattern="[a-zA-Z0-9_]+"
                                         title="Only letters, numbers, and underscore allowed">
                                  <small class="field-hint">Choose a unique username for the employee.</small>
                                </div>

                                <div class="form-group">
                                  <label for="new-employee-name">Display Name</label>
                                  <input type="text" 
                                         id="new-employee-name" 
                                         class="form-input" 
                                         required
                                         autocomplete="off"
                                         placeholder="Enter employee's full name"
                                         pattern="[A-Za-z\s]+"
                                         title="Only letters and spaces allowed">
                                  <small class="field-hint">Employee's name as shown in the system.</small>
                                </div>

                                <div class="form-group">
                                  <label for="new-employee-password">Password</label>
                                  <div class="password-input-container">
                                    <input type="password" 
                                           id="new-employee-password" 
                                           class="form-input" 
                                           required
                                           autocomplete="new-password"
                                           placeholder="Enter password"
                                           pattern=".{8,}"
                                           title="Password must be at least 8 characters long">
                                    <button type="button" class="toggle-password-btn" onclick="togglePasswordVisibility('new-employee-password')">
                                      <i class="fas fa-eye"></i>
                                    </button>
                                  </div>
                                  <small class="field-hint">Choose a strong password with letters, numbers, and symbols.</small>
                                </div>

                                <div class="form-group">
                                  <label for="new-employee-confirm-password">Confirm Password</label>
                                  <div class="password-input-container">
                                    <input type="password" 
                                           id="new-employee-confirm-password" 
                                           class="form-input" 
                                           required
                                           autocomplete="new-password"
                                           placeholder="Confirm password"
                                           pattern=".{8,}"
                                           title="Password must be at least 8 characters long">
                                    <button type="button" class="toggle-password-btn" onclick="togglePasswordVisibility('new-employee-confirm-password')">
                                      <i class="fas fa-eye"></i>
                                    </button>
                                  </div>
                                  <small class="field-hint">Re-enter the password to confirm.</small>
                                </div>

                                <div class="form-group">
                                  <label for="new-employee-role">Account Type</label>
                                  <select id="new-employee-role" 
                                         class="form-input" 
                                         required
                                         autocomplete="off">
                                    <option value="">Select account type</option>
                                    <option value="employee">Employee</option>
                                    <option value="admin">Admin</option>
                                  </select>
                                  <small class="field-hint">Select the account privileges level.</small>
                                </div>
                              </div>

                              <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                  <i class="fas fa-user-plus"></i> Create Account
                                </button>
                                <button type="reset" class="btn btn-secondary">
                                  <i class="fas fa-undo"></i> Clear Form
                                </button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </section>

                      <!-- Settings -->
              <section id="settings" class="content-section">
                <h2>Settings</h2>

                <!-- Tabs header -->
                <div class="form-header">
                  <div class="form-tabs">
                    <button type="button" class="tab-btn" onclick="showTab('settings-activity')">Activity Log</button>
                    <button type="button" class="tab-btn" onclick="showTab('settings-maintenance')">Maintenance</button>
                  </div>
                </div>

                <!-- Activity Log -->
                <div id="settings-activity" class="tab-content active">
                  <div class="audit-log-container">
                    <div class="audit-log-header">
                      <div class="audit-search-container">
                        <i class="fas fa-search audit-search-icon"></i>
                        <input type="text" id="audit-search" class="audit-search-input" placeholder="Search activities...">
                      </div>
                      <div class="audit-actions">
                        <button onclick="loadAuditLogs()" class="audit-btn refresh-btn">
                          <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button onclick="printAuditLogs()" class="audit-btn print-btn">
                          <i class="fas fa-print"></i> Print
                        </button>
                      </div>
                    </div>
                    <table class="audit-log-table">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>User</th>
                          <th>Action</th>
                          <th>IP Address</th>
                        </tr>
                      </thead>
                      <tbody id="audit-log-body">
                        <!-- Audit logs will be loaded here -->
                      </tbody>
                    </table>
                    <div id="audit-pagination" class="pagination"></div>
                  </div>
                </div>

                <!-- Maintenance -->
                <div id="settings-maintenance" class="tab-content">
                  <h3>Backup &amp; Recovery</h3>

                  <div class="form-grid">
                    <div class="form-group">
                      <label>Backup Patients (CSV)</label>
                      <p class="hint">Exports all patient records as a CSV.</p>
                      <a class="btn-success" href="{{ url_for('backup_csv') }}">‚¨á Download Backup (CSV)</a>
                    </div>

                    <div class="form-group">
                      <label>Recover from CSV</label>
                      <p class="hint">Upload a CSV exported from this system to restore data.</p>
                      <form method="POST" action="{{ url_for('restore_csv') }}" enctype="multipart/form-data">
                        <input type="file" name="file" accept=".csv" required>
                        <button type="submit" class="btn-success">‚¨Ü Restore</button>
                      </form>
                    </div>
                  </div>

                  <hr class="hr">

                  <h3>Database Maintenance</h3>
                  <div class="form-grid">
                    <div class="form-group">
                      <label>Vacuum / Optimize (SQLite)</label>
                      <p class="hint">Reclaims space and optimizes the database file.</p>
                      <form method="POST" action="{{ url_for('db_optimize') }}">
                        <button type="submit" class="btn-secondary">Run Optimize</button>
                      </form>
                    </div>
                    <div class="form-group">
                      <label>Export Raw SQLite DB</label>
                      <p class="hint">Download the `.db` file for a full offline backup.</p>
                      <a class="btn-ghost" href="{{ url_for('backup_sqlite') }}">‚¨á Download DB file</a>
                    </div>
                  </div>
                </div>
              </section>

                    </main>
                  </div>

                  <!-- Patient Details Modal -->
                  <!-- VIEW PATIENT MODAL (used by JS) -->
                  <div id="patientModal" class="modal" style="display:none">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2>Patient Details</h2>
                        <span class="close" onclick="closeModal('patientModal')">&times;</span>
                      </div>
                      <div id="patientModalBody" class="modal-body"></div>
                    </div>
                  </div>

                  <!-- VIEW PATIENT MODAL -->
                  <div id="patientModal" class="modal" style="display:none">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2>Patient Details</h2>
                        <span class="close" onclick="closeModal('patientModal')">&times;</span>
                      </div>
                      <div id="patientModalBody" class="modal-body"></div>
                    </div>
                  </div>

                  <!-- EDIT PATIENT MODAL -->
                  <div id="editPatientModal" class="modal" style="display:none">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2>Edit Patient</h2>
                        <span class="close" onclick="closeModal('editPatientModal')">&times;</span>
                      </div>
                      <div class="modal-body">
                        <form id="editPatientForm" onsubmit="return submitEditPatient(event)" method="POST">
                          <input type="hidden" id="edit_patient_id" name="id">

                          <div class="form-grid">
                            <div class="form-group">
                              <label for="edit_patient_name">Patient Name</label>
                              <input id="edit_patient_name" name="patient_name" type="text" required>
                            </div>
                            <div class="form-group">
                              <label for="edit_date_of_bite">Date of Bite</label>
                              <input id="edit_date_of_bite" name="date_of_bite" type="date">
                            </div>
                            <div class="form-group">
                              <label for="edit_service_type">Service</label>
                              <input id="edit_service_type" name="service_type" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_contact_number">Contact</label>
                              <input id="edit_contact_number" name="contact_number" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_age">Age</label>
                              <input id="edit_age" name="age" type="number" min="0">
                            </div>
                            <div class="form-group">
                              <label for="edit_gender">Gender</label>
                              <select id="edit_gender" name="gender">
                                <option value=""></option>
                                <option>Male</option>
                                <option>Female</option>
                              </select>
                            </div>
                            <div class="form-group form-group full-width">
                              <label for="edit_address">Address</label>
                              <input id="edit_address" name="address" type="text">
                            </div>

                            <div class="form-group">
                              <label for="edit_bite_location">Bite Location</label>
                              <input id="edit_bite_location" name="bite_location" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_place_of_bite">Place of Bite</label>
                              <input id="edit_place_of_bite" name="place_of_bite" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_source_of_bite">Source of Bite</label>
                              <input id="edit_source_of_bite" name="source_of_bite" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_type_of_bite">Type of Bite</label>
                              <input id="edit_type_of_bite" name="type_of_bite" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_source_status">Source Status</label>
                              <input id="edit_source_status" name="source_status" type="text">
                            </div>
                            <div class="form-group">
                              <label for="edit_exposure">Exposure</label>
                              <input id="edit_exposure" name="exposure" type="text">
                            </div>

                            <div class="form-group">
                              <label for="edit_day0">Day 0</label>
                              <input id="edit_day0" name="day0" type="date">
                            </div>
                            <div class="form-group">
                              <label for="edit_day3">Day 3</label>
                              <input id="edit_day3" name="day3" type="date">
                            </div>
                            <div class="form-group">
                              <label for="edit_day7">Day 7</label>
                              <input id="edit_day7" name="day7" type="date">
                            </div>
                            <div class="form-group">
                              <label for="edit_day14">Day 14</label>
                              <input id="edit_day14" name="day14" type="date">
                            </div>
                            <div class="form-group">
                              <label for="edit_day28">Day 28</label>
                              <input id="edit_day28" name="day28" type="date">
                            </div>
                          </div>

                          <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="closeModal('editPatientModal')">Cancel</button>
                            <button type="submit" class="btn-primary">Save Changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                <script src="{{ url_for('static', filename='employee-script.js') }}"></script>
                <script>
// Global patients data for admin dashboard
let globalPatientsData = {{ patients_json|tojson|safe }};
// Ensure it's an array
if (!Array.isArray(globalPatientsData)) {
  globalPatientsData = [];
}

// Debug function to test button click
function testGenerateReport() {
  console.log('Generate Report button clicked!');
  
  try {
    // Fetch fresh patient data from server
    fetch('/api/patients')
      .then(response => response.json())
      .then(data => {
        const patientsData = data.patients || [];
        console.log('Fresh patients data:', patientsData);
        generateReportWithData(patientsData);
      })
      .catch(error => {
        console.log('Failed to fetch fresh data, using global data:', error);
        // Fallback to global data if API fails
        const patientsData = globalPatientsData || [];
        generateReportWithData(patientsData);
      });
      
  } catch (error) {
    console.error('Error generating report:', error);
    alert('Error generating report: ' + error.message);
  }
}

function generateReportWithData(patientsData) {
  console.log('Generating report with data:', patientsData);
  
  try {
    // Simple admin report generation
    const reportSection = document.getElementById('monthlyReportSection');
    const reportContent = document.getElementById('reportContent');
    
    if (!reportSection || !reportContent) {
      alert('Report elements not found in DOM');
      return;
    }

    // Get selected period
    const periodType = document.getElementById('periodType').value;
    const viewType = document.getElementById('monthSelector').value;
    
    // Calculate date ranges based on selection
    const today = new Date();
    let startDate, endDate, periodLabel;
    
    switch(viewType) {
      case 'weekly':
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
        startDate = startOfWeek.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
        periodLabel = 'This Week';
        break;
      case 'monthly':
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        startDate = startOfMonth.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
        periodLabel = 'This Month';
        break;
      case 'yearly':
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        startDate = startOfYear.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
        periodLabel = 'This Year';
        break;
      default:
        startDate = null;
        endDate = null;
        periodLabel = 'All Time';
    }

    // Filter patients based on date range
    let filteredPatients = patientsData;
    if (startDate && endDate) {
      filteredPatients = patientsData.filter(p => {
        const patientDate = p.day0; // Use registration date
        return patientDate >= startDate && patientDate <= endDate;
      });
    }

    // Get completed patients within the period (only if day28 has passed)
    const todayStr = today.toISOString().split('T')[0];
    const completedPatients = filteredPatients.filter(p => {
      // Patient is only considered completed if:
      // 1. They have all scheduled dates (day0, day3, day7, day14, day28)
      // 2. Their day28 date has already passed (meaning treatment should be finished)
      return p.day0 && p.day3 && p.day7 && p.day14 && p.day28 && p.day28 < todayStr;
    });

    // Current stats for the selected period
    const totalPatients = filteredPatients.length;
    
    // Active patients are those who have future appointments (day28 hasn't passed yet)
    const activePatients = filteredPatients.filter(p => {
      return p.day28 && p.day28 >= todayStr; // Have day28 scheduled and it's today or in future
    }).length;
    
    const completionRate = totalPatients > 0 ? Math.round((completedPatients.length / totalPatients) * 100) : 0;

    // Previous period comparison (simplified)
    let prevTotalPatients = Math.max(0, totalPatients - 1);
    let prevCompletedPatients = Math.max(0, completedPatients.length - 1);
    let prevCompletionRate = Math.max(0, completionRate - 5);

    const getChangeText = (current, previous, label) => {
      const diff = current - previous;
      if (diff > 0) return `${label} increased by ${diff}`;
      if (diff < 0) return `${label} decreased by ${Math.abs(diff)}`;
      return `${label} remained the same`;
    };

    // Generate enhanced report
    reportContent.innerHTML = `
      <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
        <h2 style="color: #800020; border-bottom: 2px solid #800020; padding-bottom: 10px;">
          ${periodLabel} Treatment Report
        </h2>
        <p style="color: #666; margin-bottom: 20px;">
          <strong>Generated:</strong> ${new Date().toLocaleString()}<br>
          <strong>Period:</strong> ${periodLabel}${startDate ? ` (${startDate} to ${endDate})` : ''}
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6;">
            <div style="font-size: 24px; font-weight: bold; color: #800020;">${totalPatients}</div>
            <div style="font-size: 14px; color: #666;">Total Patients</div>
            <div style="font-size: 12px; color: #28a745; margin-top: 5px;">üìà ${getChangeText(totalPatients, prevTotalPatients, 'Count')}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6;">
            <div style="font-size: 24px; font-weight: bold; color: #800020;">${completedPatients.length}</div>
            <div style="font-size: 14px; color: #666;">Completed Treatments</div>
            <div style="font-size: 12px; color: #28a745; margin-top: 5px;">‚úÖ ${getChangeText(completedPatients.length, prevCompletedPatients, 'Completed')}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6;">
            <div style="font-size: 24px; font-weight: bold; color: #800020;">${activePatients}</div>
            <div style="font-size: 14px; color: #666;">Active Treatments</div>
            <div style="font-size: 12px; color: #007bff; margin-top: 5px;">üîÑ Currently ongoing</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6;">
            <div style="font-size: 24px; font-weight: bold; color: #800020;">${completionRate}%</div>
            <div style="font-size: 14px; color: #666;">Completion Rate</div>
            <div style="font-size: 12px; color: #17a2b8; margin-top: 5px;">üìä ${getChangeText(completionRate, prevCompletionRate, 'Rate')}</div>
          </div>
        </div>

        <h3 style="color: #333; margin-top: 30px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
          Completed Treatments in ${periodLabel}
        </h3>
        <table style="width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background: #800020; color: white;">
              <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Patient Name</th>
              <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Started</th>
              <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Completed</th>
              <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Service Type</th>
              <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${completedPatients.length > 0 ? 
              completedPatients.map((p, index) => `
                <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                  <td style="border: 1px solid #ddd; padding: 10px; font-weight: 500;">${p.patient_name}</td>
                  <td style="border: 1px solid #ddd; padding: 10px;">${new Date(p.day0).toLocaleDateString()}</td>
                  <td style="border: 1px solid #ddd; padding: 10px;">${new Date(p.day28).toLocaleDateString()}</td>
                  <td style="border: 1px solid #ddd; padding: 10px;">${p.service_type}</td>
                  <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
                    <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úì Completed</span>
                  </td>
                </tr>
              `).join('') :
              '<tr><td colspan="5" style="border: 1px solid #ddd; padding: 20px; text-align: center; color: #666; font-style: italic;">No completed treatments found in this period</td></tr>'
            }
          </tbody>
        </table>

        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 10px; margin-top: 25px; border: 1px solid #dee2e6;">
          <h3 style="margin-top: 0; color: #495057;">üìà ${periodLabel} Performance Analysis</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
              <h4 style="color: #495057; margin-bottom: 10px;">Period Summary:</h4>
              <ul style="line-height: 1.8; color: #6c757d;">
                <li>Patients registered: <strong style="color: #495057;">${totalPatients}</strong></li>
                <li>Treatments completed: <strong style="color: #495057;">${completedPatients.length}</strong></li>
                <li>Currently active: <strong style="color: #495057;">${activePatients}</strong></li>
                <li>Success rate: <strong style="color: #495057;">${completionRate}%</strong></li>
              </ul>
            </div>
            <div>
              <h4 style="color: #495057; margin-bottom: 10px;">Trend Analysis:</h4>
              <ul style="line-height: 1.8; color: #6c757d;">
                <li>${getChangeText(totalPatients, prevTotalPatients, 'Patient registration')}</li>
                <li>${getChangeText(completedPatients.length, prevCompletedPatients, 'Treatment completion')}</li>
                <li>${getChangeText(completionRate, prevCompletionRate, 'Success rate')}</li>
              </ul>
            </div>
          </div>
          
          ${completionRate >= 90 ? 
            '<div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin-top: 15px;"><strong>üèÜ Excellent Performance!</strong> Completion rate exceeds optimal standards. Keep up the great work!</div>' :
            completionRate >= 75 ?
            '<div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin-top: 15px;"><strong>‚úÖ Good Performance!</strong> Completion rate is within acceptable range. Consider minor improvements to reach excellence.</div>' :
            '<div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 15px;"><strong>‚ö†Ô∏è Attention Required!</strong> Completion rate needs improvement. Implement enhanced follow-up protocols.</div>'
          }
        </div>
      </div>
    `;
    
    reportSection.style.display = 'block';
    console.log('Report generated successfully for period:', periodLabel);
    
  } catch (error) {
    console.error('Error generating report:', error);
    alert('Error generating report: ' + error.message);
  }
}

// Professional Print Function for Admin Dashboard
function printProfessionalReport() {
    try {
        // Fetch fresh patient data from server
        fetch('/api/patients')
            .then(response => response.json())
            .then(data => {
                const patientsData = data.patients || [];
                generatePrintReport(patientsData);
            })
            .catch(error => {
                console.log('Failed to fetch fresh data, using global data:', error);
                // Fallback to global data if API fails
                const patientsData = globalPatientsData || [];
                generatePrintReport(patientsData);
            });
        
    } catch (error) {
        console.error('Error printing report:', error);
        alert('Error printing report: ' + error.message);
    }
}

function generatePrintReport(patientsData) {
    try {
        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('Pop-up blocked. Please allow pop-ups and try again.');
            return;
        }

        // Get current date and time
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const timeStr = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        // Get the report data
        const periodType = document.getElementById('monthSelector').value;
        let periodLabel = 'Treatment Report';
        
        switch(periodType) {
            case 'weekly': periodLabel = 'Weekly Treatment Report'; break;
            case 'monthly': periodLabel = 'Monthly Treatment Report'; break;
            case 'yearly': periodLabel = 'Annual Treatment Report'; break;
        }

        // Filter patients based on period
        const currentDate = new Date();
        let filteredPatients = patientsData;
        
        if (periodType === 'weekly') {
            const oneWeekAgo = new Date(currentDate);
            oneWeekAgo.setDate(currentDate.getDate() - 7);
            filteredPatients = patientsData.filter(p => {
                if (!p.day0) return false;
                const patientDate = new Date(p.day0);
                return patientDate >= oneWeekAgo;
            });
        } else if (periodType === 'monthly') {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            filteredPatients = patientsData.filter(p => {
                if (!p.day0) return false;
                const patientDate = new Date(p.day0);
                return patientDate.getMonth() === currentMonth && patientDate.getFullYear() === currentYear;
            });
        } else if (periodType === 'yearly') {
            const currentYear = currentDate.getFullYear();
            filteredPatients = patientsData.filter(p => {
                if (!p.day0) return false;
                const patientDate = new Date(p.day0);
                return patientDate.getFullYear() === currentYear;
            });
        }

        // Get completed patients from filtered data (only if day28 date has passed)
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        const completedPatients = filteredPatients.filter(p => {
            // Patient is only considered completed if:
            // 1. They have all scheduled dates (day0, day3, day7, day14, day28)
            // 2. Their day28 date has already passed (meaning treatment should be finished)
            return p.day0 && p.day3 && p.day7 && p.day14 && p.day28 && p.day28 < todayStr;
        });

        // Calculate stats
        const totalPatients = filteredPatients.length;
        const completedTreatments = completedPatients.length;
        
        // Active patients are those who have future appointments (day28 hasn't passed yet)
        const activePatients = filteredPatients.filter(p => {
            return p.day28 && p.day28 >= todayStr; // Have day28 scheduled and it's today or in future
        }).length;
        
        const completionRate = totalPatients > 0 ? Math.round((completedPatients.length / totalPatients) * 100) : 0;

        // Generate table rows for completed patients
        let tableRows = '';
        if (completedPatients.length > 0) {
            completedPatients.forEach((p, index) => {
                const startDate = p.day0 ? new Date(p.day0).toLocaleDateString() : 'N/A';
                const endDate = p.day28 ? new Date(p.day28).toLocaleDateString() : 'N/A';
                tableRows += `
                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                        <td style="border: 1px solid #ddd; padding: 8px;">${p.patient_name || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${startDate}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${endDate}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${p.service_type || 'N/A'}</td>
                    </tr>
                `;
            });
        } else {
            tableRows = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 15px; text-align: center; color: #666; font-style: italic;">No completed treatments found in this period</td></tr>';
        }

        console.log('Print Report Data:', {
            totalPatients,
            completedTreatments,
            activePatients,
            completionRate,
            filteredPatientsCount: filteredPatients.length,
            allPatientsCount: patientsData.length
        });

        // Write the professional print document
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${periodLabel} - ${dateStr}</title>
                <style>
                    @page {
                        margin: 0.5in;
                        size: A4;
                    }
                    
                    body { 
                        font-family: 'Arial', sans-serif;
                        line-height: 1.4;
                        margin: 0;
                        padding: 20px;
                        color: #333;
                        background: white;
                    }
                    
                    .letterhead {
                        text-align: center;
                        border-bottom: 3px solid #800020;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    
                    .clinic-logo {
                        width: 80px;
                        height: 80px;
                        margin: 0 auto 15px;
                        display: block;
                        border-radius: 8px;
                        border: 2px solid #800020;
                        object-fit: contain;
                        background: white;
                        padding: 5px;
                    }
                    
                    .clinic-name {
                        font-size: 24px;
                        font-weight: bold;
                        color: #800020;
                        margin: 10px 0 5px;
                        letter-spacing: 1px;
                    }
                    
                    .clinic-subtitle {
                        font-size: 14px;
                        color: #666;
                        margin-bottom: 5px;
                    }
                    
                    .clinic-address {
                        font-size: 12px;
                        color: #555;
                        margin: 10px 0 15px;
                        line-height: 1.4;
                        font-style: italic;
                    }
                    
                    .report-header {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 25px;
                        border-left: 4px solid #800020;
                    }
                    
                    .report-title {
                        font-size: 20px;
                        font-weight: bold;
                        color: #800020;
                        margin: 0 0 10px;
                    }
                    
                    .report-meta {
                        font-size: 12px;
                        color: #666;
                        line-height: 1.6;
                    }
                    
                    .stats-section {
                        margin: 25px 0;
                    }
                    
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 15px;
                        margin: 20px 0;
                    }
                    
                    .stat-box {
                        background: white;
                        border: 1px solid #ddd;
                        padding: 15px;
                        text-align: center;
                        border-radius: 6px;
                    }
                    
                    .stat-number {
                        font-size: 24px;
                        font-weight: bold;
                        color: #800020;
                        margin-bottom: 5px;
                    }
                    
                    .stat-label {
                        font-size: 12px;
                        color: #666;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    .section-title {
                        font-size: 16px;
                        font-weight: bold;
                        color: #333;
                        margin: 25px 0 15px;
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 5px;
                    }
                    
                    .data-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 15px 0;
                        font-size: 12px;
                    }
                    
                    .data-table th {
                        background: #800020;
                        color: white;
                        padding: 10px 8px;
                        text-align: left;
                        font-weight: bold;
                        border: 1px solid #ddd;
                    }
                    
                    .data-table td {
                        padding: 8px;
                        border: 1px solid #ddd;
                    }
                    
                    .data-table tbody tr:nth-child(even) {
                        background: #f8f9fa;
                    }
                    
                    .footer {
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                        text-align: center;
                        font-size: 11px;
                        color: #666;
                    }
                    
                    .performance-summary {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        margin: 20px 0;
                        border-left: 4px solid #28a745;
                    }
                    
                    .performance-title {
                        font-weight: bold;
                        color: #333;
                        margin-bottom: 10px;
                    }
                    
                    @media print {
                        body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        .letterhead { page-break-after: avoid; }
                        .stats-section { page-break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                <!-- Official Letterhead -->
                <div class="letterhead">
                    <img src="static/images/san lorenzo.jpg" alt="San Lorenzo Animal Bite Center Logo" class="clinic-logo">
                    <div class="clinic-name">SAN LORENZO ANIMAL BITE CENTER</div>
                    <div class="clinic-subtitle">Anti-Rabies Treatment and Prevention Services</div>
                    <div class="clinic-address">
                        0007 J.P. Rizal Street, Baranggay Manggahan, Rodriguez, Rizal<br>
                        (Near Mercury Drug - Highway, former Tambunting Pawnshop)
                    </div>
                    <div class="clinic-subtitle">Professional Healthcare Document</div>
                </div>
                
                <!-- Report Header -->
                <div class="report-header">
                    <div class="report-title">${periodLabel}</div>
                    <div class="report-meta">
                        <strong>Document Generated:</strong> ${dateStr} at ${timeStr}<br>
                        <strong>Report Period:</strong> ${periodLabel}<br>
                        <strong>Prepared By:</strong> San Lorenzo Animal Bite Center Administration<br>
                        <strong>Document Type:</strong> Official Treatment Statistics Report
                    </div>
                </div>
                
                <!-- Statistics Overview -->
                <div class="stats-section">
                    <div class="section-title">TREATMENT STATISTICS SUMMARY</div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number">${totalPatients}</div>
                            <div class="stat-label">Total Patients</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${completedTreatments}</div>
                            <div class="stat-label">Completed Treatments</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${activePatients}</div>
                            <div class="stat-label">Active Treatments</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${completionRate}%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Completed Treatments Table -->
                <div class="section-title">COMPLETED TREATMENT RECORDS</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Treatment Started</th>
                            <th>Treatment Completed</th>
                            <th>Service Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                
                <!-- Performance Summary -->
                <div class="performance-summary">
                    <div class="performance-title">PERFORMANCE ANALYSIS</div>
                    <p>This ${periodLabel.toLowerCase()} shows ${totalPatients} patients treated with a ${completionRate}% success rate. 
                    ${completedTreatments} treatments were successfully completed during this period, demonstrating 
                    ${completionRate >= 90 ? 'excellent' : completionRate >= 75 ? 'good' : 'acceptable'} 
                    clinical performance standards.</p>
                </div>
                
                <!-- Official Footer -->
                <div class="footer">
                    <p><strong>San Lorenzo Animal Bite Center</strong> | Official Treatment Report</p>
                    <p>This document contains confidential medical statistics and is intended for authorized personnel only.</p>
                    <p>Generated on ${dateStr} | Document ID: SLABC-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}</p>
                </div>
            </body>
            </html>
        `);

        printWindow.document.close();
        
        // Wait for content to load, then print
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 1000);
        
    } catch (error) {
        console.error('Error printing report:', error);
        alert('Error printing report: ' + error.message);
    }
}

function applyTheme(theme) {
  document.body.classList.remove('dark-mode');
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
  } else if (theme === 'system') {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark-mode');
    }
  }
}

function saveDisplaySettings() {
  const theme = document.getElementById('setting-theme').value;
  localStorage.setItem('theme', theme);
  applyTheme(theme);
  alert('Display settings saved.');
}

// Apply saved theme on page load
window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme') || 'system';
  const themeSelect = document.getElementById('setting-theme');
  if (themeSelect) {
    themeSelect.value = savedTheme;
  }
  applyTheme(savedTheme);
});

// If you already pass patients_json from Flask, parse once:
const PATIENTS = window.PATIENTS || (window.PATIENTS = (() => {
  try { return JSON.parse(document.getElementById('patientsJson')?.textContent || '[]'); }
  catch { return []; }
})());

// Attach click handlers to edit buttons
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-edit');
  if (!btn) return;
  const id = btn.getAttribute('data-patient-id');

  // Option A: fetch fresh data from server
  const res = await fetch(`/patient/${id}`);
  const p = await res.json();

  openEditModal(p);
});

function openEditModal(p) {
  // set action to /update-patient/<id>
  const form = document.getElementById('editPatientForm');
  form.action = `/update-patient/${p.id}`;

  // fill fields
  document.getElementById('edit_patient_id').value = p.id;
  document.getElementById('edit_patient_name').value = p.patient_name || '';
  document.getElementById('edit_date_of_bite').value = (p.date_of_bite || '').slice(0,10);
  document.getElementById('edit_service_type').value = p.service_type || '';
  document.getElementById('edit_contact_number').value = p.contact_number || '';
  document.getElementById('edit_age').value = p.age ?? '';
  document.getElementById('edit_gender').value = p.gender || '';
  document.getElementById('edit_address').value = p.address || '';
  document.getElementById('edit_bite_location').value = p.bite_location || '';
  document.getElementById('edit_place_of_bite').value = p.place_of_bite || '';
  document.getElementById('edit_source_of_bite').value = p.source_of_bite || '';
  document.getElementById('edit_type_of_bite').value = p.type_of_bite || '';
  document.getElementById('edit_source_status').value = p.source_status || '';
  document.getElementById('edit_exposure').value = p.exposure || '';
  document.getElementById('edit_day0').value = (p.day0 || '').slice(0,10);
  document.getElementById('edit_day3').value = (p.day3 || '').slice(0,10);
  document.getElementById('edit_day7').value = (p.day7 || '').slice(0,10);
  document.getElementById('edit_day14').value = (p.day14 || '').slice(0,10);
  document.getElementById('edit_day28').value = (p.day28 || '').slice(0,10);

  // show modal (whatever your show function is)
  document.getElementById('editPatientModal').style.display = 'block';
}

// trial
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-edit');
  if (!btn) return;

  const id = btn.getAttribute('data-patient-id');
  if (!id) {
    console.warn('No data-patient-id on edit button');
    return;
  }

  // Get the latest patient data from the server
  const res = await fetch(`/patient/${id}`);
  if (!res.ok) {
    alert(`Cannot load patient ${id}. Server returned ${res.status}.`);
    return;
  }
  const p = await res.json();

  console.log('Editing patient:', p); // sanity check
  openEditModal(p);                    // <-- now your function runs with a real object
});

// Activity Log Auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('activity-log-section') && typeof loadActivityLog === 'function') {
        loadActivityLog();
        // Refresh activity log every 30 seconds
        activityLogTimer = setInterval(loadActivityLog, 30000);
    }
});

</script>

<!-- Activity Log Section -->
<div id="activity-log-section" class="tab-content">
  <h2>Activity Log</h2>
  <div class="activity-log-container">
    <div class="activity-log-header">
      <div class="activity-log-controls">
        <select id="activity-filter" onchange="filterActivityLog()">
          <option value="all">All Activities</option>
          <option value="add_record">Add Records</option>
          <option value="edit_record">Edit Records</option>
          <option value="update_schedule">Schedule Changes</option>
          <option value="profile_update">Profile Changes</option>
          <option value="login">Login Events</option>
        </select>
      <button onclick="refreshActivityLog()" class="refresh-btn">
        <i class="fas fa-sync"></i> Refresh
      </button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Username</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="activity-log-body">
        <!-- Activity log entries will be loaded here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="{{ url_for('static', filename='employee-script.js') }}"></script>
<script src="{{ url_for('static', filename='audit-log.js') }}"></script>

              </body>
              </html>
