<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>San Lorenzo Animal Bite Center - Employee Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='employee-styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf for client-side PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    /* Print-friendly rules for report export */
    @media print {
      body * { visibility: hidden; }
      .report-printable, .report-printable * { visibility: visible; }
      .report-printable { position: absolute; left: 0; top: 0; width: 100%; }
      nav.sidebar, .menu-btn, .sidebar-bottom, .sidebar-menu { display: none !important; }
    }

    /* Compact report card/table styling (inline so PDF has styles) */
    .report-hr { border-top: 1px solid #e6e6e6; margin: 12px 0; }
    .report-kpi { display:flex; gap:12px; flex-wrap:wrap; }
    .report-kpi .kpi { background:#fff; border:1px solid #eee; padding:12px; border-radius:8px; min-width:140px; box-shadow:0 1px 2px rgba(0,0,0,0.03); }
    .report-kpi .kpi h4 { margin:0 0 6px; font-size:0.95rem; color:#333; }
    .report-kpi .kpi .num { font-size:1.45rem; font-weight:700; color:#a6122a; }
    .patients-report-table { width:100%; border-collapse:collapse; margin-top:8px; }
    .patients-report-table th, .patients-report-table td { border:1px solid #f0f0f0; padding:8px; text-align:left; font-size:0.95rem; }
    .patients-report-table th { background:#fafafa; }
    .overdue { background:#fff0f0; }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="{{ url_for('static', filename='images/san lorenzo.jpg') }}" alt="Clinic Logo" class="sidebar-logo">
        <h3>San Lorenzo Animal Bite Center</h3>
      </div>
      <ul class="sidebar-menu">
        <li><button class="menu-btn active" onclick="showSection('dashboard')">Dashboard</button></li>
        <li><button class="menu-btn" onclick="showSection('add-record')">Add Record</button></li>
        <li><button class="menu-btn" onclick="showSection('view-patient')">View Patient</button></li>
        <li><button class="menu-btn" onclick="showSection('view-schedule')">View Schedule</button></li>
      </ul>
      <div class="sidebar-bottom">
        <div class="employee-greeting">
          <div class="greeting-text">Hi, {{ employee_name }}!</div>
        </div>
        <div class="sidebar-bottom-actions">
          <a href="{{ url_for('logout') }}" class="menu-btn sidebar-bottom-btn">Logout</a>
          <button class="menu-btn sidebar-bottom-btn" onclick="showSection('settings')">Settings</button>
        </div>
      </div>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard -->
      <section id="dashboard" class="content-section active">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üë§</div>
            <h3>Total Patients</h3>
            <div class="stat-number">{{ patients|length }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <h3>Upcoming Appointments</h3>
            <div class="stat-number">{{ upcoming_appointments[0]['count'] if upcoming_appointments else 0 }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <h3>Patients Today</h3>
            <div class="stat-number">{{ patients_today[0]['count'] if patients_today else 0 }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <h3>Completed Treatments</h3>
            <div class="stat-number" id="completed-count">0</div>
          </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="analytics-section">
          <div class="analytics-header">
            <h3>Treatment Analytics</h3>
            <div class="analytics-controls">
              <label for="periodType">Period:</label>
              <select id="periodType" onchange="updateMonthlyReports()">
                <option value="month" selected>Monthly</option>
                <option value="year">Yearly</option>
              </select>
              <label for="monthSelector">View:</label>
              <select id="monthSelector" onchange="updateMonthlyReports()">
                <option value="all">All Time</option>
                <option value="current">Current Month</option>
                <option value="year-current">Current Year</option>
                <option value="2025">Year 2025</option>
                <option value="2025-01">January 2025</option>
                <option value="2025-02">February 2025</option>
                <option value="2025-03">March 2025</option>
                <option value="2025-04">April 2025</option>
                <option value="2025-05">May 2025</option>
                <option value="2025-06">June 2025</option>
                <option value="2025-07">July 2025</option>
                <option value="2025-08">August 2025</option>
                <option value="2025-09">September 2025</option>
                <option value="2025-10">October 2025</option>
                <option value="2025-11">November 2025</option>
                <option value="2025-12">December 2025</option>
              </select>
              <button id="generateReport" onclick="generateMonthlyReport()" class="btn-report">üìä Generate Report</button>
            </div>
          </div>
          
          <!-- Monthly Summary Cards -->
          <div class="monthly-summary" id="monthlySummary">
            <div class="summary-card">
              <h4>New Patients</h4>
              <div class="summary-number" id="monthlyNewPatients">0</div>
            </div>
            <div class="summary-card">
              <h4>Completed Treatments</h4>
              <div class="summary-number" id="monthlyCompleted">0</div>
            </div>
            <div class="summary-card">
              <h4>Active Treatments</h4>
              <div class="summary-number" id="monthlyActive">0</div>
            </div>
            <div class="summary-card">
              <h4>Completion Rate</h4>
              <div class="summary-number" id="monthlyRate">0%</div>
            </div>
          </div>

          <div class="charts-grid">
            <div class="chart-container">
              <h4>Treatment Completion Status</h4>
              <canvas id="completionChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Daily Progress (Selected Month)</h4>
              <canvas id="dailyProgressChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Treatment Types Distribution</h4>
              <canvas id="serviceChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Weekly Completion Trends</h4>
              <canvas id="weeklyTrendChart" width="400" height="200"></canvas>
            </div>
          </div>
          
          <!-- Monthly Report Section -->
            <div class="monthly-report" id="monthlyReportSection" style="display:none;">
            <h4>üìà Report</h4>
              <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
                <div style="margin-left:auto;display:flex;gap:8px;">
                  <!-- Only PDF/Print options as requested -> no CSV export -->
                  <button onclick="generateMonthlyReport(); exportReport()" class="btn-report">üì• Export Full PDF</button>
                </div>
              </div>
              <!-- reportContent will be populated with a compact KPI summary and a patients list -->
              <div class="report-content report-printable" id="reportContent"></div>
              <div style="display:flex;gap:8px;margin-top:12px;">
                <button onclick="printReport()" class="btn-print">üñ®Ô∏è Print Report</button>
                <button onclick="exportReport()" class="btn-export">üì• Export PDF</button>
              </div>
          </div>
        </div>
      </section>

      <!-- Add Record -->
      <section id="add-record" class="content-section">
        <form method="POST" action="{{ url_for('employee_dashboard') }}">
          <!-- Form Tabs -->
          <div class="form-header">
            <div class="form-tabs">
              <button
                type="button"
                class="tab-btn active"
                onclick="showTab('personal-info')"
              >
                Personal Information
              </button>
              <button
                type="button"
                class="tab-btn"
                onclick="showTab('vaccine-bite-info')"
              >
                Vaccine and Bite Information
              </button>
              <button
                type="button"
                class="tab-btn"
                onclick="showTab('schedule')"
              >
                Schedule
              </button>
              </div>
            </div>

          <!-- Personal Info -->
          <div id="personal-info" class="tab-content active">
            <div class="form-grid">
              <div class="form-section-header">
                <h4>Personal Information</h4>
              </div>
              
              <div class="form-group">
                <label>Patient Name:</label>
                <input type="text" name="patient_name" placeholder="Enter patient's full name" required>
              </div>
              <div class="form-group">
                <label>Age:</label>
                <input type="number" name="age" min="0" max="150" placeholder="Enter age" required>
              </div>
              <div class="form-group">
                <label>Gender:</label>
                <select name="gender" required>
                  <option value="">Select gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Contact Number:</label>
                <input type="tel" name="contact_number" placeholder="09XX-XXX-XXXX" required>
              </div>
              <div class="form-group full-width">
                <label>Complete Address:</label>
                <textarea name="address" rows="3" placeholder="Enter complete address including barangay, city/municipality, province" required></textarea>
              </div>
            </div>
          </div>

          <!-- Vaccine & Bite Info -->
          <div id="vaccine-bite-info" class="tab-content">
            <div class="form-grid">
              <div class="form-section-header">
                <h4>Service Information</h4>
              </div>
              
              <div class="form-group">
                <label>Service Type:</label>
                <select name="service_type" required>
                  <option value="">Select service type</option>
                  <option value="Booster">Booster</option>
                  <option value="Pre-Exposure Prophylaxis">Pre-Exposure Prophylaxis</option>
                  <option value="Post-Exposure Prophylaxis">Post-Exposure Prophylaxis</option>
                </select>
              </div>
              
              <div class="form-section-header">
                <h4>Bite Incident Details</h4>
              </div>
              
              <div class="form-group">
                <label>Date of Bite:</label>
                <input type="date" name="date_of_bite" title="When did the bite incident occur?">
              </div>
              <div class="form-group">
                <label>Bite Location on Body:</label>
                <input type="text" name="bite_location" placeholder="e.g., left hand, right leg, face" title="Where on the body was the bite located?">
              </div>
              <div class="form-group">
                <label>Place of Bite Incident:</label>
                <input type="text" name="place_of_bite" placeholder="e.g., at home, in the street, at park" title="Where did the bite incident happen?">
              </div>
              <div class="form-group">
                <label>Type of Bite:</label>
                <select name="type_of_bite">
                  <option value="">Select bite type</option>
                  <option value="One Bite">Single Bite</option>
                  <option value="Multiple Bites">Multiple Bites</option>
                  <option value="Scratch">Scratch/Laceration</option>
                  <option value="Lick on open wound">Lick on Open Wound</option>
                </select>
              </div>
              
              <div class="form-section-header">
                <h4>Animal Information</h4>
              </div>
              
              <div class="form-group">
                <label>Source of Bite:</label>
                <select name="source_of_bite">
                  <option value="">Select animal type</option>
                  <option value="Dog">Dog</option>
                  <option value="Cat">Cat</option>
                  <option value="Bat">Bat</option>
                  <option value="Monkey">Monkey</option>
                  <option value="Other">Other Animal</option>
                </select>
              </div>
              <div class="form-group">
                <label>Other Animal Specify:</label>
                <input type="text" name="other_source_of_bite" placeholder="Specify if 'Other' selected above">
              </div>
              <div class="form-group">
                <label>Animal Status:</label>
                <select name="source_status">
                  <option value="">Select status</option>
                  <option value="Alive">Alive & Observable</option>
                  <option value="Dead">Dead/Killed</option>
                  <option value="Unknown">Unknown/Lost</option>
                </select>
              </div>
              <div class="form-group">
                <label>Animal Ownership:</label>
                <select name="exposure" required>
                  <option value="">Select ownership type</option>
                  <option value="Neighbor">Neighbor</option>
                  <option value="Stranger">Stranger</option>
                  <option value="Family">Family</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              
              <div class="form-section-header">
                <h4>Vaccination History</h4>
              </div>
              <div class="form-group">
                <label>Previous Rabies Vaccination Status:</label>
                <div class="vaccination-options" style="display:flex;flex-direction:row;gap:4px;align-items:stretch;justify-content:flex-start;">
                  <div class="radio-group" style="flex:1;display:flex;align-items:center;gap:14px;min-width:320px;max-width:420px;padding:18px 20px;border:1.5px solid transparent;border-radius:12px;background:transparent;box-sizing:border-box;">
                    <input type="radio" id="vacc-yes" name="vaccinated" value="Yes" checked required>
                    <label for="vacc-yes" class="radio-label" style="margin-bottom:0;width:100%;">
                      <span class="radio-button"></span>
                      <span class="radio-text" style="display:block;">
                        <strong>Previously Vaccinated</strong>
                        <small style="display:block;">Patient has received anti-rabies vaccine within the last 2 years</small>
                      </span>
                    </label>
                  </div>
                  <div class="radio-group" style="flex:1;display:flex;align-items:center;gap:14px;min-width:320px;max-width:420px;padding:18px 20px;border:1.5px solid transparent;border-radius:12px;background:transparent;box-sizing:border-box;">
                    <input type="radio" id="vacc-no" name="vaccinated" value="No" required>
                    <label for="vacc-no" class="radio-label" style="margin-bottom:0;width:100%;">
                      <span class="radio-button"></span>
                      <span class="radio-text" style="display:block;">
                        <strong>Not Previously Vaccinated</strong>
                        <small style="display:block;">Patient has no prior anti-rabies vaccination or unsure</small>
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

            <!-- Schedule -->
            <div id="schedule" class="tab-content schedule-section">
              <div class="schedule-header">
                <h3>Anti-Rabies Vaccination Schedule</h3>
              </div>
              
              <div class="schedule-grid">
                <div class="schedule-item priority-high">
                  <div class="schedule-day">
                    <span class="day-number">Day 0</span>
                    <span class="day-description">Initial dose (exposure day)</span>
                  </div>
                  <input type="date" name="day0" class="schedule-input" required />
                  <div class="schedule-status">
                    <span class="status-badge critical">Critical</span>
                  </div>
                </div>
                
                <div class="schedule-item priority-high">
                  <div class="schedule-day">
                    <span class="day-number">Day 3</span>
                    <span class="day-description">Second dose</span>
                  </div>
                  <input type="date" name="day3" class="schedule-input" />
                  <div class="schedule-status">
                    <span class="status-badge important">Important</span>
                  </div>
                </div>
                
                <div class="schedule-item priority-medium">
                  <div class="schedule-day">
                    <span class="day-number">Day 7</span>
                    <span class="day-description">Third dose</span>
                  </div>
                  <input type="date" name="day7" class="schedule-input" />
                  <div class="schedule-status">
                    <span class="status-badge moderate">Moderate</span>
                  </div>
                </div>
                
                <div class="schedule-item priority-medium">
                  <div class="schedule-day">
                    <span class="day-number">Day 14</span>
                    <span class="day-description">Fourth dose</span>
                  </div>
                  <input type="date" name="day14" class="schedule-input" />
                  <div class="schedule-status">
                    <span class="status-badge moderate">Moderate</span>
                  </div>
                </div>
                
                <div class="schedule-item priority-low">
                  <div class="schedule-day">
                    <span class="day-number">Day 28</span>
                    <span class="day-description">Final dose</span>
                  </div>
                  <input type="date" name="day28" class="schedule-input" />
                  <div class="schedule-status">
                    <span class="status-badge low">Completion</span>
                  </div>
                </div>
              </div>
              
              <div class="schedule-notes">
                <div class="note-item">
                  <strong>Note:</strong> Dates will be auto-calculated when Day 0 is selected
                </div>
                <div class="note-item">
                  <strong>Important:</strong> Strict adherence to schedule is crucial for effectiveness
                </div>
              </div>
            </div>

          <!-- Actions -->
          <div class="form-actions">
            <button type="submit" class="btn-success">Save Record</button>
          </div>
        </form>
      </section>

      <!-- View Patient -->
      <section id="view-patient" class="content-section">
        <h2>Patient Records</h2>
        <!-- Search Toolbar -->
        <div class="table-actions" style="display:flex;align-items:center;gap:12px;margin:8px 0 12px;">
          <input id="patient-search" type="text" placeholder="Search by ID, name, date, or service" oninput="searchPatients()" style="flex:1;max-width:420px;padding:8px 10px;border:1px solid #ccc;border-radius:6px;" />
          <button class="btn-secondary" type="button" onclick="searchPatients()">Search</button>
          <button class="btn-ghost" type="button" onclick="clearSearch()">Clear</button>
          <span id="results-count" style="margin-left:auto;color:#555;font-size:.95rem;">&nbsp;</span>
        </div>
        <div class="table-container">
          <table class="patient-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Patient Name</th>
                <th>Date of Bite</th>
                <th>Service</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in patients %}
              <tr>
                <td>{{ p['id'] }}</td>
                <td>{{ p['patient_name'] }}</td>
                <td>{{ p['date_of_bite']  }}</td>
                <td>{{ p['service_type'] }}</td>
                <td class="action-buttons">
                  <button class="btn-view" data-patient-id="{{ p['id'] }}" title="View Details">
                    <img src="{{ url_for('static', filename='images/icons/istockphoto-845329690-612x612-removebg-preview.png') }}" alt="View" class="action-icon">
                  </button>
                  <button class="btn-edit" data-patient-id="{{ p['id'] }}" title="Edit Patient">
                    <img src="{{ url_for('static', filename='images/icons/3512833-removebg-preview.png') }}" alt="Edit" class="action-icon">
                  </button>
                  <button class="btn-delete" data-patient-id="{{ p['id'] }}" title="Delete Patient">
                    <img src="{{ url_for('static', filename='images/icons/images-removebg-preview.png') }}" alt="Delete" class="action-icon">
                  </button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5">No patients found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- View Schedule -->
      <section id="view-schedule" class="content-section">
        
        <h2>Schedule Calendar</h2>
        <!-- Calendar Header (ADDED) -->
        <div class="calendar-header">
          <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
          <div id="calendar-month-year" style="font-weight:600;"></div>
          <button class="calendar-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
        <!-- Calendar Stats -->
        <div class="calendar-stats">
          <div class="stat-card">
            <h3>Today's Patients</h3>
            <div class="stat-number">{{ patients_today[0]['count'] if patients_today else 0 }}</div>
          </div>
          <!-- Calendar Grid -->
          <div class="calendar-container">
            <div class="calendar-weekdays">
              <div class="weekday">Sun</div>
              <div class="weekday">Mon</div>
              <div class="weekday">Tue</div>
              <div class="weekday">Wed</div>
              <div class="weekday">Thu</div>
              <div class="weekday">Fri</div>
              <div class="weekday">Sat</div>
            </div>
            <div class="calendar-days" id="calendar-days">
              <!-- Calendar days will be generated by JavaScript -->
            </div>
          </div>

          <!-- Schedule Legend -->
          <div class="schedule-legend">
            <h4>Schedule Legend:</h4>
            <div class="legend-items">
              <div class="legend-item">
                <div class="legend-color day0"></div>
                <span>Day 0 (Initial Dose)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color day3"></div>
                <span>Day 3</span>
              </div>
              <div class="legend-item">
                <div class="legend-color day7"></div>
                <span>Day 7</span>
              </div>
              <div class="legend-item">
                <div class="legend-color day14"></div>
                <span>Day 14</span>
              </div>
              <div class="legend-item">
                <div class="legend-color day28"></div>
                <span>Day 28 (Final)</span>
              </div>
            </div>
          </div>

          <!-- Daily Schedule Details -->
          <div class="daily-schedule" id="daily-schedule">
            <h4>Appointments for <span id="selected-date"></span></h4>
            <div class="appointment-list" id="appointment-list">
              <p>Select a date to view appointments</p>
            </div>
          </div>

          <!-- Appointment Details Modal for Calendar (used by JS) -->
          <div id="appointmentModal" class="modal" style="display:none">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Appointment Details</h2>
                <span class="close" onclick="closeAppointmentModal()">&times;</span>
              </div>
              <div id="appointmentDetailsContent" class="modal-body"></div>
            </div>
          </div>

          <!-- Toast Notification (for appointment actions) -->
          <div id="copilot-toast" style="display:none"></div>

          <!-- Appointment Actions Modal -->
          <div id="appointmentActionsModal" class="modal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Appointment Actions</h2>
                <span class="close" onclick="closeAppointmentModal()">&times;</span>
              </div>
              <div class="modal-body">
                <div class="appointment-info">
                  <h3 id="modal-appointment-patient"></h3>
                  <p><strong>Date:</strong> <span id="modal-appointment-date"></span></p>
                  <p><strong>Service:</strong> <span id="modal-appointment-service"></span></p>
                  <p><strong>Schedule:</strong> <span id="modal-appointment-schedule"></span></p>
                </div>
                <div class="appointment-actions-grid">
                  <button class="action-btn view-btn" onclick="viewAppointmentDetails()">
                    üëÅÔ∏è View Details
                  </button>
                  <button class="action-btn done-btn" onclick="markAsDone()">
                    ‚úÖ Mark as Done
                  </button>
                  <button class="action-btn noshow-btn" onclick="markAsNoShow()">
                    ‚ùå Mark as No Show
                  </button>
                  <button class="action-btn reschedule-btn" onclick="rescheduleAppointment()">
                    üìÖ Reschedule
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- Settings -->
<section id="settings" class="content-section">
  <h2>Settings</h2>

  <!-- Tabs header -->
  <div class="form-header">
    <div class="form-tabs">
      <button type="button" class="tab-btn active" onclick="showTab('settings-display')">Account</button>
      {%- if role == 'admin' %}
      <button type="button" class="tab-btn" onclick="showTab('settings-activity')">Activity Log</button>
      <button type="button" class="tab-btn" onclick="showTab('settings-maintenance')">Maintenance</button>
      {%- endif %}
    </div>
  </div>

  <!-- Display -->
  <div id="settings-display" class="tab-content active">
    {%- if role == 'admin' %}
    <div class="form-grid">
      <div class="form-group">
        <label>Theme</label>
        <select id="setting-theme">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <p class="hint">Choose how the app appears.</p>
      </div>

      <div class="form-group">
        <label>Density</label>
        <select id="setting-density">
          <option value="comfortable">Comfortable</option>
          <option value="compact">Compact</option>
        </select>
      </div>
    </div>
    <div class="form-actions">
      <button type="button" class="btn-success" onclick="saveDisplaySettings()">Save Display Settings</button>
    </div>
    {%- else %}
    <!-- Employee account settings: username, display name, change password -->
    <form method="POST" action="{{ url_for('settings') }}" class="account-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="username">Username</label>
          <input id="username" name="username" type="text" value="{{ session.get('employee_id', '') }}" required />
        </div>
        <div class="form-group">
          <label for="display_name">Display Name</label>
          <input id="display_name" name="display_name" type="text" value="{{ session.get('employee_name', '') }}" required />
        </div>
        <div class="form-group full-width">
          <label for="current_password">Current Password</label>
          <input id="current_password" name="current_password" type="password" placeholder="Enter current password if changing" />
        </div>
        <div class="form-group">
          <label for="new_password">New Password</label>
          <input id="new_password" name="new_password" type="password" />
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirm New Password</label>
          <input id="confirm_password" name="confirm_password" type="password" />
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-success">Save Account</button>
      </div>
    </form>
    {%- endif %}
  </div>

  <!-- Activity Log -->
  {% if session.get('role') == 'admin' %}
  <div id="settings-activity" class="tab-content">
    <h3>Recent Activity</h3>
    <div class="table-container">
      <table class="patient-table">
        <thead>
          <tr>
            <th>When</th>
            <th>User</th>
            <th>Action</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="activity-log-body">
          <!-- Filled by JS (optional). You can also server-render rows here. -->
          <tr><td colspan="4">No activity yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  </div>

  <!-- Maintenance -->
  <div id="settings-maintenance" class="tab-content">
    <h3>Backup &amp; Recovery</h3>

    <div class="form-grid">
      <div class="form-group">
        <label>Backup Patients (CSV)</label>
        <p class="hint">Exports all patient records as a CSV.</p>
        <a class="btn-success" href="{{ url_for('backup_csv') }}">‚¨á Download Backup (CSV)</a>
      </div>

      <div class="form-group">
        <label>Recover from CSV</label>
        <p class="hint">Upload a CSV exported from this system to restore data.</p>
        <form method="POST" action="{{ url_for('restore_csv') }}" enctype="multipart/form-data">
          <input type="file" name="file" accept=".csv" required>
          <button type="submit" class="btn-success">‚¨Ü Restore</button>
        </form>
      </div>
    </div>

    <hr class="hr">

    <h3>Database Maintenance</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Vacuum / Optimize (SQLite)</label>
        <p class="hint">Reclaims space and optimizes the database file.</p>
        <form method="POST" action="{{ url_for('db_optimize') }}">
          <button type="submit" class="btn-secondary">Run Optimize</button>
        </form>
      </div>
      <div class="form-group">
        <label>Export Raw SQLite DB</label>
        <p class="hint">Download the `.db` file for a full offline backup.</p>
        <a class="btn-ghost" href="{{ url_for('backup_sqlite') }}">‚¨á Download DB file</a>
      </div>
    </div>
  </div>
  {% endif %}
</section>

      </main>
    </div>

    <!-- Patient Details Modal -->
    <!-- VIEW PATIENT MODAL (used by JS) -->
    <div id="patientModal" class="modal" style="display:none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Patient Details</h2>
          <span class="close" onclick="closeModal('patientModal')">&times;</span>
        </div>
        <div id="patientModalBody" class="modal-body"></div>
      </div>
    </div>

    <!-- VIEW PATIENT MODAL -->
    <div id="patientModal" class="modal" style="display:none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Patient Details</h2>
          <span class="close" onclick="closeModal('patientModal')">&times;</span>
        </div>
        <div id="patientModalBody" class="modal-body"></div>
      </div>
    </div>

    <!-- EDIT PATIENT MODAL -->
    <div id="editPatientModal" class="modal" style="display:none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Patient</h2>
          <span class="close" onclick="closeModal('editPatientModal')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editPatientForm" onsubmit="return submitEditPatient(event)">
            <input type="hidden" id="edit_patient_id">

            <div class="form-grid">
              <div class="form-group">
                <label for="edit_patient_name">Patient Name</label>
                <input id="edit_patient_name" type="text" required>
              </div>
              <div class="form-group">
                <label for="edit_date_of_bite">Date of Bite</label>
                <input id="edit_date_of_bite" type="date">
              </div>
              <div class="form-group">
                <label for="edit_service_type">Service</label>
                <input id="edit_service_type" type="text">
              </div>
              <div class="form-group">
                <label for="edit_contact_number">Contact</label>
                <input id="edit_contact_number" type="text">
              </div>
              <div class="form-group">
                <label for="edit_age">Age</label>
                <input id="edit_age" type="number" min="0">
              </div>
              <div class="form-group">
                <label for="edit_gender">Gender</label>
                <select id="edit_gender">
                  <option value=""></option>
                  <option>Male</option>
                  <option>Female</option>
                </select>
              </div>
              <div class="form-group form-group full-width">
                <label for="edit_address">Address</label>
                <input id="edit_address" type="text">
              </div>

              <div class="form-group">
                <label for="edit_bite_location">Bite Location</label>
                <input id="edit_bite_location" type="text">
              </div>
              <div class="form-group">
                <label for="edit_place_of_bite">Place of Bite</label>
                <input id="edit_place_of_bite" type="text">
              </div>
              <div class="form-group">
                <label for="edit_source_of_bite">Source of Bite</label>
                <input id="edit_source_of_bite" type="text">
              </div>
              <div class="form-group">
                <label for="edit_type_of_bite">Type of Bite</label>
                <input id="edit_type_of_bite" type="text">
              </div>
              <div class="form-group">
                <label for="edit_source_status">Source Status</label>
                <input id="edit_source_status" type="text">
              </div>
              <div class="form-group">
                <label for="edit_exposure">Exposure</label>
                <input id="edit_exposure" type="text">
              </div>

              <div class="form-group">
                <label for="edit_day0">Day 0</label>
                <input id="edit_day0" type="date">
              </div>
              <div class="form-group">
                <label for="edit_day3">Day 3</label>
                <input id="edit_day3" type="date">
              </div>
              <div class="form-group">
                <label for="edit_day7">Day 7</label>
                <input id="edit_day7" type="date">
              </div>
              <div class="form-group">
                <label for="edit_day14">Day 14</label>
                <input id="edit_day14" type="date">
              </div>
              <div class="form-group">
                <label for="edit_day28">Day 28</label>
                <input id="edit_day28" type="date">
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="closeModal('editPatientModal')">Cancel</button>
              <button type="submit" class="btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  <script>
    // Expose current user role to client scripts so UI/behavior can adapt
    window.currentUserRole = "{{ role|default('employee') }}";
  </script>
  <!-- Patients JSON payload for client JS (safe insertion) -->
  <script id="patients-data" type="application/json">{{ patients_json|safe }}</script>
  <script>
    // Build a simple, printable report containing KPIs and a patients list.
    // Patients data is injected from server-side context.
    try {
      // Read patients JSON from a script[type="application/json"] element to avoid JS parsing issues.
      let patients = [];
      const patientsScript = document.getElementById('patients-data');
      if (patientsScript && patientsScript.textContent) {
        try { patients = JSON.parse(patientsScript.textContent); } catch(e) { patients = []; console.error('Invalid patients JSON', e); }
      }

      function generateMonthlyReport() {
  // Simple aggregates - include all patients in the report list
  const patientWithService = patients || [];
  const newPatients = patientWithService.length;
        console.log('generateMonthlyReport: parsed patients count =', patientWithService.length);
        if (patientWithService.length > 0) console.log('sample patient', patientWithService[0]);
        // best-effort completed count if data provided
        const completed = patients.filter(p => p && (p.status === 'Completed' || p.treatment_completed)).length || 0;
        const active = patients.filter(p => p && (p.status === 'In Progress' || p.status === 'Active')).length || 0;
        const completionRate = newPatients > 0 ? Math.round((completed / newPatients) * 100) : 0;

        // Update small dashboard numbers if present
        const elCompleted = document.getElementById('completed-count');
        if (elCompleted) elCompleted.textContent = completed;

        // Build report HTML
        const now = new Date();
        const headerHtml = `
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <h2 style="margin:0;color:#a6122a;">San Lorenzo Animal Bite Center</h2>
              <div style="color:#666;font-size:0.95rem;margin-top:6px;">Treatment Totals ‚Äî Generated ${now.toLocaleString()}</div>
            </div>
            <div style="text-align:right;color:#666;font-size:0.95rem;">Report Period: ${document.getElementById('monthSelector') ? document.getElementById('monthSelector').value : 'All Time'}</div>
          </div>
          <div class="report-hr"></div>
        `;

        const kpiHtml = `
          <div class="report-kpi">
            <div class="kpi"><h4>New Patients</h4><div class="num">${newPatients}</div></div>
            <div class="kpi"><h4>Completed Treatments</h4><div class="num">${completed}</div></div>
            <div class="kpi"><h4>Active Treatments</h4><div class="num">${active}</div></div>
            <div class="kpi"><h4>Completion Rate</h4><div class="num">${completionRate}%</div></div>
          </div>
          <div class="report-hr"></div>
        `;

        let tableRows = '';
        if (patientWithService.length === 0) {
          tableRows = '<tr><td colspan="5">No patients match the selected criteria.</td></tr>';
        } else {
          patientWithService.forEach(p => {
            const d = p.date_of_bite || p.date || '';
            const svc = p.service_type || p.service || '';
            const overdueClass = (p.status && (p.status === 'Overdue' || p.status === 'Missed')) ? 'overdue' : '';
            tableRows += `<tr class="${overdueClass}"><td>${p.id || ''}</td><td>${p.patient_name || ''}</td><td>${svc}</td><td>${d}</td><td>${p.assigned || p.assigned_staff || ''}</td></tr>`;
          });
        }

        const tableHtml = `
          <h4>Patients Included in Report</h4>
          <table class="patients-report-table">
            <thead>
              <tr><th>ID</th><th>Patient Name</th><th>Service</th><th>Date</th><th>Assigned</th></tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        `;

        const reportContent = document.getElementById('reportContent');
        if (reportContent) {
          reportContent.innerHTML = headerHtml + kpiHtml + tableHtml;
          console.log('reportContent html length =', reportContent.innerHTML.length);
          console.log('reportContent preview:', reportContent.innerText.slice(0,300));
          document.getElementById('monthlyReportSection').style.display = 'block';
          // Scroll into view so user sees report area
          reportContent.scrollIntoView({behavior: 'smooth'});
        }
      }

      function exportReport() {
        const el = document.getElementById('reportContent');
        // If report not generated yet, generate it automatically before exporting
        if (!el || !el.innerHTML.trim()) {
          console.log('exportReport: report empty, generating before export');
          generateMonthlyReport();
        }
        // Use html2pdf to create a printable PDF
        const opt = {
          margin:       10,
          filename:     `SanLorenzo_Report_${new Date().toISOString().slice(0,10)}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 1.25, useCORS: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        // Slight timeout ensures DOM updated by generateMonthlyReport before html2pdf runs
        setTimeout(() => {
          const exportEl = document.getElementById('reportContent');
          if (!exportEl || !exportEl.innerHTML.trim()) return alert('Report generation failed.');
          html2pdf().set(opt).from(exportEl).save();
        }, 250);
      }

      function printReport() {
        // Ensure report is generated and visible
        const el = document.getElementById('reportContent');
        if (!el || !el.innerHTML.trim()) { generateMonthlyReport(); }
        window.print();
      }

      // Expose to global scope for buttons
      window.generateMonthlyReport = generateMonthlyReport;
      window.exportReport = exportReport;
      window.printReport = printReport;
    } catch (err) {
      console.error('Error building report:', err);
      window.generateMonthlyReport = function(){ alert('Report generation is unavailable.'); };
      window.exportReport = function(){ alert('PDF export unavailable.'); };
      window.printReport = function(){ alert('Print unavailable.'); };
    }
  </script>
  <script src="{{ url_for('static', filename='employee-script.js') }}"></script>
</body>
</html>

